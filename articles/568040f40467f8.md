---
title: "[CDK]AWS Chatbotã§GuardDutyã‚¢ãƒ©ãƒ¼ãƒˆã‚’slackã«é€šçŸ¥ã™ã‚‹"
emoji: "ğŸ˜º"
type: "tech" # tech: æŠ€è¡“è¨˜äº‹ / idea: ã‚¢ã‚¤ãƒ‡ã‚¢
topics: ["aws", "cdk", "guardduty"]
published: false
---

## Amazon GuardDutyã¨ã¯

Amazon GuardDutyã¯ã€AWSã‚¢ã‚«ã‚¦ãƒ³ãƒˆã‚„AWSç’°å¢ƒå†…ã®è„…å¨ã«å¯¾ã—ã¦ã€æ©Ÿæ¢°å­¦ç¿’ã«ã‚ˆã‚‹é«˜åº¦ãªç•°å¸¸æ¤œçŸ¥ã‚’ç¶™ç¶šçš„ã«è¡Œã†ã‚µãƒ¼ãƒ“ã‚¹ã§ã™ã€‚
è©³ã—ã„èª¬æ˜ã¯å…¬å¼ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã‚’ã”è¦§ãã ã•ã„ã€‚ğŸ‘‰[Amazon GuardDuty ã®ç‰¹å¾´](https://aws.amazon.com/jp/guardduty/features/)

## CDKã«ã‚ˆã‚‹ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—

### GuardDutyã®æœ‰åŠ¹åŒ–

ã¾ãšã¯GuardDutyã‚’æœ‰åŠ¹åŒ–ã—ã¦ã„ãã¾ã™ã€‚

[aws-cdk-lib.aws_guardduty module Â· AWS CDK](https://docs.aws.amazon.com/cdk/api/v2/docs/aws-cdk-lib.aws_guardduty-readme.html)

å…¬å¼ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã«ã‚ã‚‹ã‚ˆã†ã«ã€GuardDutyã®L2ã‚³ãƒ³ã‚¹ãƒˆãƒ©ã‚¯ãƒˆã¯ç¾æ™‚ç‚¹ã§ã¯ãªã„ãŸã‚ã€L1ã‚³ãƒ³ã‚¹ãƒˆãƒ©ã‚¯ãƒˆã‚’ç”¨ã„ã¦ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—ã—ã¾ã™ã€‚

```typescript: GuardDutyã®æœ‰åŠ¹åŒ–
import * as CDK from 'aws-cdk-lib';
import * as GUARDDUTY from 'aws-cdk-lib/aws-guardduty';
import { Construct } from 'constructs';
import { pascalCase } from 'change-case';

export class SetupGuarddutyStack extends CDK.Stack {
  constructor(scope: Construct, id: string, props: CDK.StackProps) {
    super(scope, id, props);

    // enable guardduty detector
    new GUARDDUTY.CfnDetector(
      this,
      'EnableGuarddutyDetector',
      {
        enable: true,
      }
    );
  }
}
```

AWSãŒãƒãƒƒã‚¯ã‚°ãƒ©ãƒ³ãƒ‰ã§å–å¾—ã—ã¦ã„ã‚‹æƒ…å ±ã‚’ä½¿ç”¨ã—åˆ†æã‚’è¡Œã†ãŸã‚ã€åˆ©ç”¨è€…å´ã§å„ãƒ­ã‚°ã®æœ‰åŠ¹åŒ–ã‚’è¡Œã£ãŸã‚Šã¨ã„ã£ãŸãƒ­ã‚°åŸºç›¤ã®æ•´å‚™ã‚’ã—ãŸã‚Šã€ç›£è¦–å¯¾è±¡ã®ãƒªã‚½ãƒ¼ã‚¹ã‚„ã‚µãƒ¼ãƒ“ã‚¹ã‚’GuardDutyãŒã‚¢ã‚¯ã‚»ã‚¹ã§ãã‚‹ã‚ˆã†ã«ãƒãƒªã‚·ãƒ¼ãªã©ã‚’è¨­å®šã™ã‚‹å¿…è¦ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚

### æ¤œå‡ºã•ã‚ŒãŸè„…å¨ã®é€šçŸ¥

GuardDutyã¯æ¤œçŸ¥ã‚’æä¾›ã™ã‚‹ã‚µãƒ¼ãƒ“ã‚¹ã§ã‚ã‚‹ãŸã‚ã€æ¤œçŸ¥ã•ã‚ŒãŸè„…å¨ã«å¯¾ã—ã¦ã®é€šçŸ¥ã®ä»•çµ„ã¿ã‚’æ•´å‚™ã™ã‚‹ã€æ¤œå‡ºã•ã‚ŒãŸè„…å¨ã¸ã®å¯¾å¿œã‚’åˆ©ç”¨è€…å´ã§ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ã‚’èµ·ã“ã™å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚

#### SNSãƒˆãƒ”ãƒƒã‚¯ã‚’ä½œæˆ

```diff typescript
  import * as CDK from 'aws-cdk-lib';
  import * as GUARDDUTY from 'aws-cdk-lib/aws-guardduty';
+ import * as SNS from 'aws-cdk-lib/aws-sns';
  import { Construct } from 'constructs';

  export class SetupGuarddutyStack extends CDK.Stack {
    constructor(scope: Construct, id: string, props: CDK.StackProps) {
      super(scope, id, props);

      // enable guardduty detector
      new GUARDDUTY.CfnDetector(
        this,
        'EnableGuarddutyDetector',
        {
          enable: true,
        }
      );

+     // create topic
+     const topic = new SNS.Topic(
+       this,
+       'CreateGuarddutyNotificationTopic',
+       {
+         topicName: 'guardduty-notification-topic',
+       }
+     );
    }
  }
```

#### EventBridgeã®è¨­å®š

```diff typescript
  import * as CDK from 'aws-cdk-lib';
+ import * as EVENTS from 'aws-cdk-lib/aws-events';
+ import * as EVENTS_TARGETS from 'aws-cdk-lib/aws-events-targets';
  import * as GUARDDUTY from 'aws-cdk-lib/aws-guardduty';
  import * as SNS from 'aws-cdk-lib/aws-sns';
  import { Construct } from 'constructs';

  export class SetupGuarddutyStack extends CDK.Stack {
    constructor(scope: Construct, id: string, props: CDK.StackProps) {
      super(scope, id, props);

      // enable guardduty detector
      new GUARDDUTY.CfnDetector(
        this,
        'EnableGuarddutyDetector',
        {
          enable: true,
        }
      );

      // create topic
      const topic = new SNS.Topic(
        this,
        'CreateGuarddutyNotificationTopic',
        {
          topicName: 'guardduty-notification-topic',
        }
      );

+     // create event rule
+     new EVENTS.Rule(
+       this,
+       'CreateGuarddutyNotificationRule',
+       {
+         ruleName: 'guardduty-notification-rule',
+         eventPattern: {
+           source: ['aws.guardduty'],
+           detailType: ['GuardDuty Finding'],
+         },
+         targets: [new EVENTS_TARGETS.SnsTopic(topic)],
+       }
+     );
    }
  }
```
https://techblog.techfirm.co.jp/entry/eventbridge-rules-debugging

EventBridgeãƒ«ãƒ¼ãƒ«ã«ã¯ã€ã‚¤ãƒ™ãƒ³ãƒˆãƒ‘ã‚¿ãƒ¼ãƒ³ã¨ã‚¿ãƒ¼ã‚²ãƒƒãƒˆã®äºŒã¤ã®è¨­å®šãŒã‚ã‚Šã¾ã™ã€‚
ã‚¤ãƒ™ãƒ³ãƒˆãƒ‘ã‚¿ãƒ¼ãƒ³ã§ã¯ã€EventBusã‹ã‚‰ç‰¹å®šã®ã‚¤ãƒ™ãƒ³ãƒˆã‚’æŠ½å‡ºã™ã‚‹ãŸã‚ã®ãƒãƒƒãƒãƒ³ã‚°ãƒ‘ã‚¿ãƒ¼ãƒ³ã‚’è¨­å®šã—ã¾ã™ã€‚

#### é€šçŸ¥ã‚’è¦‹ã‚„ã™ãã™ã‚‹

```diff typescript
      // create event rule
      new EVENTS.Rule(
        this,
        'CreateGuarddutyNotificationRule',
        {
          ruleName: 'guardduty-notification-rule',
          eventPattern: {
            source: ['aws.guardduty'],
            detailType: ['GuardDuty Finding'],
          },
-         targets: [new EVENTS_TARGETS.SnsTopic(topic)],
+         targets: [
+           new EVENTS_TARGETS.SnsTopic(topic, {
+             message: EVENTS.RuleTargetInput.fromText(
+               `WARNING: AWS ${
+                 EVENTS.EventField.account
+               } has a severity ${EVENTS.EventField.fromPath(
+                 '$.detail.severity'
+               )} GuardDuty finding type ${EVENTS.EventField.fromPath(
+                 '$.detail.type'
+               )} in the ${
+                 EVENTS.EventField.region
+               } region.\n Finding Description: ${EVENTS.EventField.fromPath(
+                 '$.detail.description'
+               )}.\n For more details open the GuardDuty console at https://console.aws.amazon.com/guardduty/home?region=${
+                 EVENTS.EventField.region
+               }#/findings?search=id%3D${EVENTS.EventField.fromPath(
+                 '$.detail.id'
+               )}`
+             ),
+           })
+         ]
        }
      );
```

#### AWS Chatbotã¨slackã®æº–å‚™

### GuardDutyã‹ã‚‰ã®ã‚¤ãƒ™ãƒ³ãƒˆé€šçŸ¥ã‚’è¦‹ã‚„ã™ãã™ã‚‹

[Amazon CloudWatch Events ã‚’ä½¿ç”¨ã—ãŸ GuardDuty ã®æ¤œå‡ºçµæœã«å¯¾ã™ã‚‹ã‚«ã‚¹ã‚¿ãƒ ãƒ¬ã‚¹ãƒãƒ³ã‚¹ã®ä½œæˆ - Amazon GuardDuty](https://docs.aws.amazon.com/ja_jp/guardduty/latest/ug/guardduty_findings_cloudwatch.html)

> SNSã‹ã‚‰ã®ãƒ¡ãƒ¼ãƒ«ã§GuardDutyã®ã‚¤ãƒ™ãƒ³ãƒˆã‚’é€šçŸ¥ã•ã›ã‚‹ã“ã¨ã£ã¦çµæ§‹ã‚ã‚‹ã¨æ€ã†ã®ã§ã™ãŒã€ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã ã¨ç”Ÿã®JSONãŒå‡ºåŠ›ã•ã‚Œã‚‹ã®ã§ã‹ãªã‚Šè¦‹è¾›ã„ã§ã™ã€‚ã‚µãƒ³ãƒ—ãƒ«ã‚¤ãƒ™ãƒ³ãƒˆã‚’ç™ºè¡Œã—ã¦ã¿ã‚‹ã¨ã“ã‚“ãªæ„Ÿã˜ã§ãƒ¡ãƒ¼ãƒ«ãŒé€šçŸ¥ã•ã‚Œã¾ã™ã€‚ã¡ã‚‡ã£ã¨æƒ…å ±é‡ãŒå¤šãã¦æ•´å½¢ã—ãªã„ã¨è¦‹ã‚‹ã®ãŒã—ã‚“ã©ã„â€¦
> 

### é‡è¦åº¦åˆ¥

[é‡è¦åº¦åˆ¥ã«GuardDutyã‚’Slackã«é€šçŸ¥ã—ã¦ã¿ãŸ | DevelopersIO](https://dev.classmethod.jp/articles/notify_guardduty_by_severity/)

## ãƒ†ã‚¹ãƒˆ

### è„…å¨ã®ã‚µãƒ³ãƒ—ãƒ«

[https://ap-northeast-1.console.aws.amazon.com/guardduty/home?region=ap-northeast-1#/settings:~:text=ã™ãè¨­å®šã™ã‚‹-,æ¤œå‡ºçµæœã®ã‚µãƒ³ãƒ—ãƒ«,-æƒ…å ±](https://ap-northeast-1.console.aws.amazon.com/guardduty/home?region=ap-northeast-1#/settings:~:text=%E3%81%99%E3%81%90%E8%A8%AD%E5%AE%9A%E3%81%99%E3%82%8B-,%E6%A4%9C%E5%87%BA%E7%B5%90%E6%9E%9C%E3%81%AE%E3%82%B5%E3%83%B3%E3%83%97%E3%83%AB,-%E6%83%85%E5%A0%B1)

### bin

```typescript
import * as CDK from 'aws-cdk-lib';
import { SetupGuarddutyStack } from '../lib/setup-guardduty-stack';

const app = new CDK.App();
const env = { account: '992999844535', region: 'ap-northeast-1' };

const setupGuarddutyStack = new SetupGuarddutyStack(
  app,
  'SetupGuarddutyStack',
  { env }
);
```


## å‚è€ƒ

https://zenn.dev/yuta28/articles/eventbridge-slack
https://dev.classmethod.jp/articles/cdk-guardduty-slack/